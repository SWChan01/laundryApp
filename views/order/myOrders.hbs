<script>
    $(document).ready(function(){

        let userEmail;
        var status;

        $("#dialog").dialog({
            autoOpen:false,
            show: {
                effect: "blind",
                duration: 1000,
            },
            resizable: false,
            hide: {
                effect: "explode",
                duration: 1000
            }
        });


        $.ajax({url:'/api/userData', success: function(res){
            userEmail=res.userEmail
            status=res.status;
            console.log("oirhgejio");
            console.log(userEmail);
        }});


        function convertDate(inStr){
            if((typeof inStr == 'undefined') || (inStr == null) || 
                (inStr.length <= 0)) {
                return '';
                }
                var year = inStr.substring(0, 4);
                var month = inStr.substring(5, 7);
                var day = inStr.substring(8, 10);
                return month + '/' + day + '/' + year;
        }



        $.ajax({url:'/api/orders/userOrder', success: function(result){
            console.log(result);
            //$("#first").html(JSON.stringify(result));
            //$("#first").html(userEmail);


            if(status=="customer"){
                let header="<th>Order ID</th><th>Prefered delivery date</th><th>Order status</th><th>laundromat name</th><th>laundromat phone#</th><th>laundromat address</th><th>Actions</th>";
                $("#th").html(header);
            }else if(status=="owner"){
                let header="<th>Order ID</th><th>Prefered delivery date</th><th>Order status</th><th>Customer name</th><th>Cusomter email</th><th>Customer address</th><th>Actions</th>";
                $("#th").html(header);
            }



            let body="";


            for(let i=0;i<result.length;i++){

                console.log(status);


                

                if(status=="customer"){

                    body+="<tr>";
                    body+="<td>"+result[i].orderID+"</td>";
                    body+="<td>"+convertDate(result[i].preferedDeliveryDate)+"</td>";
                    body+="<td>"+result[i].orderStatus+"</td>";
                    body+="<td>"+result[i].laundromatName+"</td>";
                    body+="<td>"+result[i].ownerPhone+"</td>";
                    body+="<td>"+result[i].laundromatAddress+"</td>";
                    body+="<td>"+document.getElementById("customerDropdown").innerHTML+"</td>";

                    body+="</tr>";
                }



                else if(status=="owner"){

                    if(result[i].orderStatus!="Delivered"){

                        body+="<tr>";
                        body+="<td>"+result[i].orderID+"</td>";
                        body+="<td>"+convertDate(result[i].preferedDeliveryDate)+"</td>";
                        body+="<td>"+result[i].orderStatus+"</td>";
                        body+="<td>"+result[i].customerName+"</td>"
                        body+="<td>"+result[i].userEmail+"</td>";
                        body+="<td class=address>"+result[i].customerAddress+"</td>";
                        
                        // document.getElementById("ownerDropdown").getElementsByClassName("dropdown")[0].id="order#"+result[i].orderID;
                        body+="<td>"+document.getElementById("ownerDropdown").innerHTML+"</td>";

                        body+="</tr>";
                    }
                }
            }



            $("#tbody").html(body);
        }});


        $(document).on("click",".option",(e)=>{
            let option=$(e.target).text();
            console.log(option);

            if(option=="Accept order"){
                let target = ($(e.target).parent().parent().parent().prev().prev().prev().prev().prev().prev()).text();
                console.log(target);
                
                $.ajax({
                    url:`/api/orders/acceptOrder/${target}`,
                    type:'PUT',
                    success:function(){
                        location.reload();
                    }
                });
            }

            else if(option=="Notify pickup"){
                let target=($(e.target).parent().parent().parent().prev().prev().prev().prev().prev().prev()).text();
                console.log(target);
                
                $.ajax({
                    url:`/api/orders/notifyPickup/${target}`,
                    type:'PUT',
                    success:function(){
                        location.reload();
                    },
                    error:function(err){
                        console.log(err);
                    }
                });    
            }
            
            else if(option=="Cancel order"){
                console.log("reguhoigre")
                let target=($(e.target).parent().parent().parent().prev().prev().prev().prev().prev().prev()).text();
                console.log(target);

                $.ajax({
                    url:`/api/orders/cancelOrder/${target}`,
                    type:'DELETE',
                    success:function(){
                        location.reload();
                    },
                    error:function(err){
                        console.log(err);
                    }
                })

            }

            else if(option=="Order delivered"){
                let target=($(e.target).parent().parent().parent().prev().prev().prev().prev().prev().prev()).text();
                console.log("order delivered")
                $.ajax({
                    url:`/api/orders/orderDelivered/${target}`,
                    type:'PUT',
                    success:function(){
                        location.reload();
                    },
                    error:function(err){
                        console.log(err);
                    }
                })
            }

            else if(option=="Rate service"){
                let target=($(e.target).parent().parent().parent().prev().prev().prev().prev().prev().prev()).text();
                console.log("rating service");
                $.ajax({
                    url:`/api/orders/rateOrder/${target}`,
                    type:'PUT',
                    success:function(res){
                        $("#containID").val(`${target}`);
                        $( "#dialog" ).dialog( "open" );
                        //location.reload();
                    },
                    error:function(err){
                        location.reload();
                        console.log(err);
                    }
                });
            }

        });









    });
</script>


<script type="text/template" id="customerDropdown">


    <div class="dropdown">
        <button class="btn btn-secondary dropdown-toggle" type="button" data-toggle="dropdown">
            Dropdown button
        </button>
        <div class="dropdown-menu" >
            <a class="dropdown-item option" href="">Cancel order</a>
            <a class="dropdown-item option"  id="opener">Rate service</a>
        </div>
    </div>


</script>

<script type="text/template" id="ownerDropdown">


    <div class="dropdown">
        <button class="btn btn-secondary dropdown-toggle" type="button" data-toggle="dropdown">
            Dropdown button
        </button>
        <div class="dropdown-menu" >
            <a class="dropdown-item option" href="">Accept order</a>
            <a class="dropdown-item option" href="">Notify pickup</a>
            <a class="dropdown-item option" href="">Order delivered</a>
            <a class="dropdown-item option" href="">Cancel order</a>
        </div>
    </div>


</script>




{{#unless login}}
    <div class="container text-center">
        <h1><a href="/login">Login</a> to see your current orders. Don't have an account? <a href="/register">Register!</a></h1>
    </div>
{{/unless}}




{{#if message}}
    <div class="alert alert-info text-center">
        {{message}}
    </div>
{{/if}}


 <div class="stars" id="dialog">
    <p>Please submit a review for this order</p>
    <form action="" method="POST">
        <div class="mr-4">
            <input class="star star-5" id="star-5" type="radio" name="star" value="5"/>
            <label class="star star-5" for="star-5"></label>
            <input class="star star-4" id="star-4" type="radio" name="star" value="4"/>
            <label class="star star-4" for="star-4"></label>
            <input class="star star-3" id="star-3" type="radio" name="star" value="3"/>
            <label class="star star-3" for="star-3"></label>
            <input class="star star-2" id="star-2" type="radio" name="star" value="2"/>
            <label class="star star-2" for="star-2"></label>
            <input class="star star-1" id="star-1" type="radio" name="star" value="1"/>
            <label class="star star-1" for="star-1"></label>
            <input type="text" id="containID" style="display: none;" name="containID">
        </div>
        <button type="submit" class="btn btn-primary" id="btnSubmit" value="Submit">Submit</button>
    </form>
</div>





<h1 id="first"></h1>



<div class="container">
    <table class="table">
        <thead id="th">


        </thead>


        <tbody id="tbody">
        </tbody>
    </table>

</div>


<style>
div.stars {
  width: 270px;
  display: inline-block;
}

input.star { display: none; }

label.star {
  float: right;
  padding: 10px;
  font-size: 20px;
  color: #444;
  transition: all .2s;
}

input.star:checked ~ label.star:before {
  content: '\f005';
  color: #FD4;
  transition: all .25s;
}

input.star-5:checked ~ label.star:before {
  color: #FE7;
  text-shadow: 0 0 20px #952;
}

input.star-1:checked ~ label.star:before { color: #F62; }

label.star:hover { transform: rotate(-15deg) scale(1.3); }

label.star:before {
  content: '\f006';
  font-family: FontAwesome;
}

#btnSubmit{
    margin-left:80px;
}
</style>